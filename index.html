<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Property Line App</title>

<!-- p5.js -->
<script src="https://cdn.jsdelivr.net/npm/p5@1.11.7/lib/p5.js"></script>
<script src="https://cdn.jsdelivr.net/npm/p5@1.11.7/lib/addons/p5.sound.min.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
  :root {
    --bg: #f5f5f5;
    --text: #333;
    --card: #fff;
    --border: #ccc;
    --input-bg: #fff;
    --accent: #007aff;
  }
  body.dark {
    --bg: #1e1e1e;
    --text: #ddd;
    --card: #2c2c2c;
    --border: #444;
    --input-bg: #333;
    --accent: #0a84ff;
  }
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
    background: var(--bg);
    color: var(--text);
  }
  h2, h3 {
    margin: 10px 0;
  }
  #map {
    height: 60vh;
  }
  .controls {
    padding: 15px;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    margin: 10px;
  }
  select, input[type="text"], input[type="range"], button {
    width: 100%;
    padding: 10px;
    margin-top: 8px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px;
    background: var(--input-bg);
    color: var(--text);
    box-sizing: border-box;
  }
  .pin-row {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 8px;
  }
  .pin-row input[type="text"] {
    flex: 1 1 55%;
    margin-right: 5px;
  }
  .pin-row button {
    flex: 1 1 25%;
    margin-right: 5px;
    padding: 8px;
  }
  .pin-row input[type="checkbox"] {
    flex: 0 0 auto;
    width: 20px;
    height: 20px;
  }
  .slider-container {
    display: flex;
    align-items: center;
    margin-top: 8px;
  }
  .slider-container input {
    flex-grow: 1;
  }
  .coordinate-display {
    margin-top: 10px;
    background: var(--input-bg);
    padding: 8px;
    border-radius: 8px;
    font-size: 15px;
    border: 1px solid var(--border);
  }
  #modeToggle {
    margin-bottom: 15px;
    background: var(--accent);
    color: #fff;
    border: none;
    font-weight: 600;
  }
  @media (max-width: 600px) {
    .pin-row {
      flex-direction: column;
    }
    .pin-row input, .pin-row button {
      width: 100%;
      margin-bottom: 5px;
    }
  }
</style>
</head>

<body>

<div class="controls">
  <button id="modeToggle">üåô Toggle Dark/Light Mode</button>
  <h2>Enter Pin Coordinates</h2>
  <label>Format:</label>
  <select id="formatSelect">
    <option value="decimal">Decimal Degrees</option>
  </select>

  <div id="pinsContainer"></div>
  <button id="addPinBtn">Add Pin</button>
  <button id="plotBtn">Plot Property Line</button>

  <div id="sliderSection" style="display:none; margin-top:15px;">
    <h3>Select Point along Line</h3>
    <div class="slider-container">
      <input type="range" id="fractionSlider" min="0" max="1" step="0.001" value="0.5" />
      <span id="fractionVal">0.5</span>
    </div>
    <div class="coordinate-display" id="selectedPoint">Lat: --, Lon: --</div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
function parseInput(v) {
  const [lat, lon] = v.split(',').map(s => parseFloat(s.trim()));
  if (isNaN(lat) || isNaN(lon)) return null;
  return [lat, lon];
}

let tileLight = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' });
let tileDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '¬© CartoDB' });

const map = L.map('map', { zoomControl: false }).setView([0,0], 2);
tileLight.addTo(map);

let markers = [], propertyLine, selMarker;
const pinsContainer = document.getElementById('pinsContainer');
let pinCount = 0;

function addPinField() {
  pinCount++;
  const row = document.createElement('div');
  row.className = 'pin-row';
  row.innerHTML = 
    <input type="text" class="coordInput" placeholder="Pin ${pinCount}: Lat, Lon"/>
    <button onclick="useMyLocation(this)">üìç</button>
    <input type="checkbox" class="pin-select"/>
  ;
  pinsContainer.appendChild(row);
}

function useMyLocation(button) {
  if (!navigator.geolocation) {
    alert('Geolocation not supported.');
    return;
  }
  button.disabled = true;
  button.innerText = '‚åõ';
  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      const acc = pos.coords.accuracy.toFixed(1);
      button.parentElement.querySelector('.coordInput').value = ${lat}, ${lon} (¬±${acc}m);
      button.disabled = false;
      button.innerText = 'üìç';
    },
    err => {
      alert('Could not get location.');
      button.disabled = false;
      button.innerText = 'üìç';
    }
  );
}

addPinField();
addPinField();

document.getElementById('addPinBtn').onclick = () => addPinField();

document.getElementById('plotBtn').onclick = () => {
  markers.forEach(m => map.removeLayer(m)); markers = [];
  if (propertyLine) map.removeLayer(propertyLine);
  if (selMarker) map.removeLayer(selMarker);

  const selected = Array.from(document.querySelectorAll('.pin-row'))
    .filter(r => r.querySelector('.pin-select').checked);

  if (selected.length !== 2) {
    alert('Select exactly two pins.');
    return;
  }

  const coords = selected.map(r => parseInput(r.querySelector('.coordInput').value));
  if (coords.some(c => !c)) {
    alert('Invalid coordinate in selected pins.');
    return;
  }

  coords.forEach(c => markers.push(L.marker(c).addTo(map)));
  propertyLine = L.polyline(coords, { color:'var(--accent)' }).addTo(map);
  map.fitBounds(propertyLine.getBounds().pad(0.5));

  document.getElementById('sliderSection').style.display = 'block';
  updateSelectedPoint();
};

const slider = document.getElementById('fractionSlider');
slider.oninput = () => {
  document.getElementById('fractionVal').innerText = slider.value;
  updateSelectedPoint();
};

function interpolate(p1, p2, f) {
  return [p1[0] + (p2[0] - p1[0]) * f, p1[1] + (p2[1] - p1[1]) * f];
}

function updateSelectedPoint() {
  if (!propertyLine) return;
  const points = propertyLine.getLatLngs();
  const f = parseFloat(slider.value);
  const p = interpolate([points[0].lat, points[0].lng], [points[1].lat, points[1].lng], f);
  if (selMarker) map.removeLayer(selMarker);
  selMarker = L.marker(p, { icon: L.divIcon({ className:'selected-point', html:'<div style="background:red;width:12px;height:12px;border-radius:50%;"></div>' }) }).addTo(map);
  document.getElementById('selectedPoint').innerText = Lat: ${p[0].toFixed(6)}, Lon: ${p[1].toFixed(6)};
}

// Dark/Light Mode Toggle
document.getElementById('modeToggle').onclick = () => {
  document.body.classList.toggle('dark');
  if (document.body.classList.contains('dark')) {
    map.removeLayer(tileLight);
    tileDark.addTo(map);
  } else {
    map.removeLayer(tileDark);
    tileLight.addTo(map);
  }
};
</script>

</body>
</html>
